<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>hearme</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      display: flex;
      justify-content: center;
      padding: 2rem 1rem;
      min-height: 100vh;
    }
    .app {
      width: 100%;
      max-width: 420px;
    }
    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .subtitle {
      color: #888;
      font-size: 0.85rem;
      margin-bottom: 2rem;
    }
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #222;
    }
    .tab {
      flex: 1;
      padding: 0.75rem;
      text-align: center;
      cursor: pointer;
      color: #666;
      border-bottom: 2px solid transparent;
      transition: color 0.2s, border-color 0.2s;
      font-size: 0.9rem;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
    }
    .tab.active {
      color: #fff;
      border-bottom-color: #646cff;
    }
    .panel { display: none; }
    .panel.active { display: block; }
    label {
      display: block;
      font-size: 0.8rem;
      color: #888;
      margin-bottom: 0.4rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    select, input, textarea {
      width: 100%;
      padding: 0.6rem 0.75rem;
      background: #151515;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
      color: #e0e0e0;
      font-size: 0.9rem;
      margin-bottom: 1rem;
      outline: none;
    }
    select:focus, input:focus, textarea:focus {
      border-color: #646cff;
    }
    textarea {
      resize: none;
      font-family: monospace;
      font-size: 0.75rem;
      height: 4.5rem;
    }
    .btn {
      width: 100%;
      padding: 0.75rem;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn:hover { opacity: 0.85; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-share {
      background: #646cff;
      color: #fff;
    }
    .btn-stop {
      background: #ff4444;
      color: #fff;
    }
    .btn-listen {
      background: #22c55e;
      color: #fff;
    }
    .btn-copy {
      background: #2a2a2a;
      color: #ccc;
      margin-top: 0.5rem;
      font-size: 0.8rem;
      padding: 0.5rem;
    }
    .ticket-box {
      display: none;
      margin-top: 1rem;
      padding: 1rem;
      background: #111;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
    }
    .ticket-box .ticket-label {
      font-size: 0.75rem;
      color: #888;
      margin-bottom: 0.4rem;
      text-transform: uppercase;
    }
    .ticket-box code {
      display: block;
      word-break: break-all;
      font-size: 0.7rem;
      color: #a0a0ff;
      line-height: 1.4;
      max-height: 4rem;
      overflow-y: auto;
    }
    .status {
      margin-top: 1rem;
      padding: 0.6rem;
      border-radius: 6px;
      font-size: 0.8rem;
      text-align: center;
      display: none;
    }
    .status.info { display: block; background: #1a1a3a; color: #8888ff; }
    .status.ok { display: block; background: #0a2a0a; color: #44cc44; }
    .status.err { display: block; background: #2a0a0a; color: #ff6666; }
    .refresh-btn {
      background: none;
      border: 1px solid #333;
      color: #888;
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      cursor: pointer;
      margin-left: 0.5rem;
    }
    .label-row {
      display: flex;
      align-items: center;
      margin-bottom: 0.4rem;
    }
    .label-row label { margin-bottom: 0; }
  </style>
</head>
<body>
  <div class="app">
    <h1>hearme</h1>
    <p class="subtitle">share your app audio, peer-to-peer</p>

    <div class="tabs">
      <button class="tab active" data-panel="share">Share</button>
      <button class="tab" data-panel="listen">Listen</button>
    </div>

    <!-- Share Panel -->
    <div id="share" class="panel active">
      <div class="label-row">
        <label for="source-select">Audio Source</label>
        <button class="refresh-btn" id="refresh-btn">refresh</button>
      </div>
      <select id="source-select">
        <option value="">Loading sources...</option>
      </select>

      <button class="btn btn-share" id="share-btn">Start Sharing</button>
      <button class="btn btn-stop" id="stop-share-btn" style="display:none">Stop Sharing</button>

      <div class="ticket-box" id="ticket-box">
        <div class="ticket-label">Share this ticket with listeners:</div>
        <code id="ticket-code"></code>
        <button class="btn btn-copy" id="copy-btn">Copy to clipboard</button>
      </div>

      <div class="status" id="share-status"></div>
    </div>

    <!-- Listen Panel -->
    <div id="listen" class="panel">
      <label for="ticket-input">Paste ticket</label>
      <textarea id="ticket-input" placeholder="Paste the sharer's ticket here..."></textarea>

      <button class="btn btn-listen" id="listen-btn">Start Listening</button>
      <button class="btn btn-stop" id="stop-listen-btn" style="display:none">Stop Listening</button>

      <div class="status" id="listen-status"></div>
    </div>
  </div>

  <script>
    // Tauri IPC — the __TAURI__ global is injected by the Tauri runtime
    const { invoke } = window.__TAURI__.core;
    const { listen } = window.__TAURI__.event;

    // ── Tab switching ──
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.panel).classList.add('active');
      });
    });

    // ── Share panel ──
    const sourceSelect = document.getElementById('source-select');
    const shareBtn = document.getElementById('share-btn');
    const stopShareBtn = document.getElementById('stop-share-btn');
    const ticketBox = document.getElementById('ticket-box');
    const ticketCode = document.getElementById('ticket-code');
    const copyBtn = document.getElementById('copy-btn');
    const shareStatus = document.getElementById('share-status');
    const refreshBtn = document.getElementById('refresh-btn');

    let sources = [];

    async function loadSources() {
      try {
        sourceSelect.innerHTML = '<option value="">Loading...</option>';
        sources = await invoke('list_audio_sources');
        sourceSelect.innerHTML = sources.length
          ? sources.map((s, i) => `<option value="${i}">${s.name}</option>`).join('')
          : '<option value="">No audio sources found</option>';
      } catch (e) {
        sourceSelect.innerHTML = `<option value="">Error: ${e}</option>`;
      }
    }

    refreshBtn.addEventListener('click', loadSources);

    shareBtn.addEventListener('click', async () => {
      const idx = parseInt(sourceSelect.value);
      if (isNaN(idx) || !sources[idx]) return;

      setStatus(shareStatus, 'info', 'Starting share...');
      shareBtn.disabled = true;

      try {
        const ticket = await invoke('start_sharing', { source: sources[idx] });
        ticketCode.textContent = ticket;
        ticketBox.style.display = 'block';
        shareBtn.style.display = 'none';
        stopShareBtn.style.display = 'block';
        setStatus(shareStatus, 'ok', 'Sharing audio. Listeners can connect with the ticket above.');
      } catch (e) {
        setStatus(shareStatus, 'err', `Error: ${e}`);
        shareBtn.disabled = false;
      }
    });

    stopShareBtn.addEventListener('click', async () => {
      try {
        await invoke('stop_sharing');
      } catch (e) {
        console.error(e);
      }
      shareBtn.style.display = 'block';
      shareBtn.disabled = false;
      stopShareBtn.style.display = 'none';
      ticketBox.style.display = 'none';
      setStatus(shareStatus, 'info', 'Sharing stopped.');
    });

    copyBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(ticketCode.textContent);
      copyBtn.textContent = 'Copied!';
      setTimeout(() => { copyBtn.textContent = 'Copy to clipboard'; }, 1500);
    });

    // ── Listen panel ──
    const ticketInput = document.getElementById('ticket-input');
    const listenBtn = document.getElementById('listen-btn');
    const stopListenBtn = document.getElementById('stop-listen-btn');
    const listenStatus = document.getElementById('listen-status');

    listenBtn.addEventListener('click', async () => {
      const ticket = ticketInput.value.trim();
      if (!ticket) return;

      setStatus(listenStatus, 'info', 'Connecting...');
      listenBtn.disabled = true;

      try {
        await invoke('start_listening', { ticketStr: ticket });
        listenBtn.style.display = 'none';
        stopListenBtn.style.display = 'block';
        setStatus(listenStatus, 'ok', 'Connected. Playing audio...');
      } catch (e) {
        setStatus(listenStatus, 'err', `Error: ${e}`);
        listenBtn.disabled = false;
      }
    });

    stopListenBtn.addEventListener('click', async () => {
      try {
        await invoke('stop_listening');
      } catch (e) {
        console.error(e);
      }
      listenBtn.style.display = 'block';
      listenBtn.disabled = false;
      stopListenBtn.style.display = 'none';
      setStatus(listenStatus, 'info', 'Disconnected.');
    });

    // ── Events from backend ──
    listen('share-ended', () => {
      stopShareBtn.click();
      setStatus(shareStatus, 'info', 'Share ended (source stopped).');
    });

    listen('listen-ended', () => {
      stopListenBtn.click();
      setStatus(listenStatus, 'info', 'Stream ended (sharer disconnected).');
    });

    // ── Helpers ──
    function setStatus(el, cls, text) {
      el.className = `status ${cls}`;
      el.textContent = text;
    }

    // ── Init ──
    loadSources();
  </script>
</body>
</html>
